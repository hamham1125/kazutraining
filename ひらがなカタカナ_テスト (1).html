<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ã²ã‚‰ãŒãªãƒ»ã‚«ã‚¿ã‚«ãƒŠ ãƒ†ã‚¹ãƒˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* ========= å…±é€šï¼ˆã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆç·´ç¿’ã¨åŒç³»çµ±ã®è¦‹ãŸç›®ï¼‰ ========= */
    body { background:#fff7dc; font-family:'Rounded Mplus 1c', system-ui, -apple-system, Segoe UI, sans-serif; text-align:center; margin:0; padding:54px 10px 30px; }
    h1 { font-size:2em; margin:0 0 14px; }

    /* ãƒœã‚¿ãƒ³é¡ï¼ˆã‚¯ãƒªãƒƒã‚¯æŠ¼ã—è¾¼ã¿è¡¨ç¾ã‚’å¾©æ´»ï¼‰ */
    .audio-button, .nav-button, .option { cursor:pointer; user-select:none; transition: transform .08s ease, box-shadow .08s ease; }
    .audio-button { font-size:1.05em; padding:8px 14px; border-radius:12px; border:none; background:#ffca28; box-shadow:0 4px 0 #f0b400; }
    .nav-button { font-size:1em; padding:10px 16px; border:none; border-radius:10px; background:#ccc; box-shadow:0 3px 0 #bdbdbd; }
    .option { min-width:120px; min-height:72px; font-size:2rem; padding:10px 16px; border:none; border-radius:16px; background:#fff; box-shadow:0 4px 0 #bdbdbd; }
    .audio-button:active, .nav-button:active, .option:active { transform: translateY(2px) scale(0.98); box-shadow:0 2px 0 rgba(0,0,0,.2); }

    /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒãƒ¼ï¼ˆ1è¡Œã«åã‚ã‚‹ã€‚ç‹­ã„æ™‚ã¯æŠ˜è¿”ã—ï¼‰ */
    .controls { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; align-items:center; background:rgba(255,255,255,.88); padding:10px 12px; border-radius:14px; box-shadow:0 2px 0 rgba(0,0,0,.1); }
    .controls select { font-size:1rem; padding:8px 12px; border-radius:10px; background:#fff; border:1px solid #ddd; }
    .spacer { width:8px; height:1px; }

    .questionWrap { margin-top:18px; }
    .bigNotice { font-size:1.1em; color:#333; margin:6px 0 12px; }

    /* 5æŠã‚¨ãƒªã‚¢ */
    .options { display:flex; justify-content:center; flex-wrap:wrap; gap:16px; margin-top:12px; }

    /* æ‰‹æ›¸ãã‚¨ãƒªã‚¢ */
    .drawWrap { display:none; margin:10px auto 0; max-width:360px; }
    .canvasBox { position:relative; margin:0 auto; width:320px; height:320px; background:#fff; border-radius:12px; box-shadow:inset 0 0 0 2px #333; }
    canvas { width:320px; height:320px; touch-action:none; display:block; background:#fff; }
    /* 4åˆ†å‰²ã‚¬ã‚¤ãƒ‰ */
    .grid::before { content:""; position:absolute; inset:0; pointer-events:none; background:
      linear-gradient(#ddd 1px, transparent 1px) 0 50%/100% 1px,
      linear-gradient(90deg, #ddd 1px, transparent 1px) 50% 0/1px 100%; }

    .drawTools { display:flex; justify-content:center; gap:8px; margin-top:10px; flex-wrap:wrap; align-items:center; }
    .label { font-size:.95em; opacity:.85; }

    /* ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆã€‡Ã—ï¼‰ */
    #feedback { font-size:4.6em; color:#e60000; line-height:1; display:none; margin:10px 0; text-shadow:0 2px 4px rgba(0,0,0,.15); }

    /* çµæœ */
    #resultPanel { margin-top:16px; font-size:1.1em; }

    /* è¨˜éŒ²ãƒªãƒ¼ãƒ€ï¼ˆå·¦ä¸Šå›ºå®šï¼‰ */
    #recordToggle { position:fixed; top:10px; left:10px; background:#ffd54f; padding:8px 12px; border-radius:10px; font-size:1em; z-index:1000; border:none; box-shadow:0 3px 0 #f0b400; cursor:pointer; }
    #recordPanel { position:fixed; top:52px; left:10px; width:min(92vw, 360px); max-height:80vh; overflow:auto; background:#fff; border:2px solid #e0c36a; border-radius:12px; padding:12px; text-align:left; display:none; z-index:1000; }
    #recordPanel h3 { margin:6px 0 8px; }
    .recItem { border:1px solid #eee; padding:8px; border-radius:8px; margin-bottom:8px; background:#fafafa; }
    .recItem summary { cursor:pointer; }

    /* è¨­å®šãƒ€ã‚¤ã‚¢ãƒ­ã‚° */
    dialog#settings { border:none; border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.25); padding:16px; }
    #settings .row { display:flex; align-items:center; gap:10px; }
    #settings input[type=range] { width:200px; }

    .footer { margin-top:22px; }

    /* DEV ãƒ‘ãƒãƒ« */
    #devPanel { display:none; text-align:left; margin:16px auto; max-width:600px; background:#fffbe6; border:1px solid #e0c36a; padding:10px 12px; border-radius:10px; }
  </style>
</head>
<body>
  <!-- è¨˜éŒ²ãƒˆã‚°ãƒ« -->
  <button id="recordToggle">ğŸ“Š ãã‚ã</button>
  <div id="recordPanel">
    <h3>ãã‚ãï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼‰</h3>
    <div style="display:flex; gap:8px; margin-bottom:8px;">
      <button class="nav-button" id="refreshRec">âŸ³ æ›´æ–°</button>
      <button class="nav-button" id="clearRec" style="background:#ffb3b3">ğŸ—‘ ãœã‚“ã¶æ¶ˆã™</button>
    </div>
    <div id="recordList"></div>
  </div>

  <h1>ã²ã‚‰ãŒãªãƒ»ã‚«ã‚¿ã‚«ãƒŠ ãƒ†ã‚¹ãƒˆ</h1>
  <div class="controls">
    <button id="startBtn" class="nav-button">â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    <button id="resetBtn" class="nav-button">â†º ãƒªã‚»ãƒƒãƒˆ</button>
    <div class="spacer"></div>
    <label class="label">æ–‡å­—ç¨®ï¼š</label>
    <select id="scriptSel">
      <option value="hira">ã²ã‚‰ãŒãª</option>
      <option value="kata">ã‚«ã‚¿ã‚«ãƒŠ</option>
    </select>
    <label class="label">ã‚»ãƒƒãƒˆï¼š</label>
    <select id="setSel">
      <option value="seion">æ¸…éŸ³</option>
      <option value="dakuon">æ¿éŸ³</option>
      <option value="handakuon">åŠæ¿éŸ³</option>
      <option value="yoon">æ‹—éŸ³</option>
      <option value="all">ãœã‚“ã¶</option>
    </select>
    <label class="label">ãƒ¢ãƒ¼ãƒ‰ï¼š</label>
    <select id="modeSel">
      <option value="choice">5æŠ</option>
      <option value="hand">æ‰‹æ›¸ãï¼ˆåŠè‡ªå‹•ï¼‰</option>
    </select>
    <button id="openSettings" class="nav-button" title="åˆ¤å®šã®ã‚„ã•ã—ã•">âš™ è¨­å®š</button>
  </div>

  <div class="questionWrap">
    <div class="bigNotice" id="prompt">ãŠã¨ã‚’ãã„ã¦ã€€ãˆã‚‰ã‚“ã§ã­ / ã‹ã„ã¦ã­</div>
    <div style="margin-bottom:10px; display:flex; justify-content:center; gap:8px; flex-wrap:wrap;">
      <button class="audio-button" id="playBtn">â–¶ ãŠã¨ã‚’ãã</button>
      <button class="audio-button" id="replayBtn" style="display:none">â–¶ ã‚‚ã†ã„ã£ã‹ã„</button>
    </div>

    <!-- 5æŠ -->
    <div id="choiceArea" class="options"></div>

    <!-- æ‰‹æ›¸ã -->
    <div id="handArea" class="drawWrap">
      <div class="canvasBox grid">
        <canvas id="draw"></canvas>
      </div>
      <div class="drawTools">
        <button class="nav-button" id="undoBtn">â†© 1ã¤æˆ»ã™</button>
        <button class="nav-button" id="clearBtn">ğŸ§½ ãœã‚“ã¶æ¶ˆã™</button>
        <button class="audio-button" id="autoBtn">ã“ãŸãˆ</button>
        <span class="label">å…ˆç”Ÿâ˜‘ï¼ˆ</span>
        <button class="nav-button" id="markGood" title="ã€‡ï¼šæ­£è§£">ã€‡</button>
        <button class="nav-button" id="markMaybe" title="â–³ï¼šãŠã—ã„">â–³</button>
        <button class="nav-button" id="markBad" title="Ã—ï¼šã¡ãŒã†">Ã—</button>
        <span class="label">ï¼‰</span>
      </div>
    </div>

    <div id="feedback">ã€‡</div>
    <div id="progress" class="bigNotice"></div>
    <div id="resultPanel"></div>
  </div>

  <!-- è¨­å®šãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
  <dialog id="settings">
    <form method="dialog">
      <h3 style="margin-top:0">âš™ è¨­å®š</h3>
      <div class="row" style="margin:8px 0 12px;">
        <label style="min-width:6em">ã‚„ã•ã—ã•</label>
        <input type="range" id="leniency" min="1" max="5" step="1" value="4" />
        <span id="lenVal">4</span>
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end">
        <button class="nav-button" value="cancel">ã¨ã˜ã‚‹</button>
        <button class="nav-button" id="saveSettings" value="default">ä¿å­˜</button>
      </div>
    </form>
  </dialog>

  <div id="devPanel"></div>

  <div class="footer">
    <button class="nav-button" onclick="location.href='å›½èª.html'">â† ã‚‚ã©ã‚‹</button>
  </div>

<script>
/******************* ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ *******************/
const KANA = {
  hira: {
    seion: ['ã‚','ã„','ã†','ãˆ','ãŠ','ã‹','ã','ã','ã‘','ã“','ã•','ã—','ã™','ã›','ã','ãŸ','ã¡','ã¤','ã¦','ã¨','ãª','ã«','ã¬','ã­','ã®','ã¯','ã²','ãµ','ã¸','ã»','ã¾','ã¿','ã‚€','ã‚','ã‚‚','ã‚„','ã‚†','ã‚ˆ','ã‚‰','ã‚Š','ã‚‹','ã‚Œ','ã‚','ã‚','ã‚’','ã‚“'],
    dakuon: ['ãŒ','ã','ã','ã’','ã”','ã–','ã˜','ãš','ãœ','ã','ã ','ã¢','ã¥','ã§','ã©','ã°','ã³','ã¶','ã¹','ã¼'],
    handakuon: ['ã±','ã´','ã·','ãº','ã½'],
    yoon: ['ãã‚ƒ','ãã‚…','ãã‚‡','ã—ã‚ƒ','ã—ã‚…','ã—ã‚‡','ã¡ã‚ƒ','ã¡ã‚…','ã¡ã‚‡','ã«ã‚ƒ','ã«ã‚…','ã«ã‚‡','ã²ã‚ƒ','ã²ã‚…','ã²ã‚‡','ã¿ã‚ƒ','ã¿ã‚…','ã¿ã‚‡','ã‚Šã‚ƒ','ã‚Šã‚…','ã‚Šã‚‡','ãã‚ƒ','ãã‚…','ãã‚‡','ã˜ã‚ƒ','ã˜ã‚…','ã˜ã‚‡','ã³ã‚ƒ','ã³ã‚…','ã³ã‚‡','ã´ã‚ƒ','ã´ã‚…','ã´ã‚‡']
  },
  kata: {
    seion: ['ã‚¢','ã‚¤','ã‚¦','ã‚¨','ã‚ª','ã‚«','ã‚­','ã‚¯','ã‚±','ã‚³','ã‚µ','ã‚·','ã‚¹','ã‚»','ã‚½','ã‚¿','ãƒ','ãƒ„','ãƒ†','ãƒˆ','ãƒŠ','ãƒ‹','ãƒŒ','ãƒ','ãƒ','ãƒ','ãƒ’','ãƒ•','ãƒ˜','ãƒ›','ãƒ','ãƒŸ','ãƒ ','ãƒ¡','ãƒ¢','ãƒ¤','ãƒ¦','ãƒ¨','ãƒ©','ãƒª','ãƒ«','ãƒ¬','ãƒ­','ãƒ¯','ãƒ²','ãƒ³'],
    dakuon: ['ã‚¬','ã‚®','ã‚°','ã‚²','ã‚´','ã‚¶','ã‚¸','ã‚º','ã‚¼','ã‚¾','ãƒ€','ãƒ‚','ãƒ…','ãƒ‡','ãƒ‰','ãƒ','ãƒ“','ãƒ–','ãƒ™','ãƒœ'],
    handakuon: ['ãƒ‘','ãƒ”','ãƒ—','ãƒš','ãƒ'],
    yoon: ['ã‚­ãƒ£','ã‚­ãƒ¥','ã‚­ãƒ§','ã‚·ãƒ£','ã‚·ãƒ¥','ã‚·ãƒ§','ãƒãƒ£','ãƒãƒ¥','ãƒãƒ§','ãƒ‹ãƒ£','ãƒ‹ãƒ¥','ãƒ‹ãƒ§','ãƒ’ãƒ£','ãƒ’ãƒ¥','ãƒ’ãƒ§','ãƒŸãƒ£','ãƒŸãƒ¥','ãƒŸãƒ§','ãƒªãƒ£','ãƒªãƒ¥','ãƒªãƒ§','ã‚®ãƒ£','ã‚®ãƒ¥','ã‚®ãƒ§','ã‚¸ãƒ£','ã‚¸ãƒ¥','ã‚¸ãƒ§','ãƒ“ãƒ£','ãƒ“ãƒ¥','ãƒ“ãƒ§','ãƒ”ãƒ£','ãƒ”ãƒ¥','ãƒ”ãƒ§']
  }
};
function buildPool(script, set){ const d = KANA[script]; return (set==='all')? [...d.seion, ...d.dakuon, ...d.handakuon, ...d.yoon] : [...d[set]]; }
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }

/******************* çŠ¶æ…‹ *******************/
let script = 'hira';
let setKind = 'seion';
let mode = 'choice'; // 'choice' | 'hand'
let pool = [];
let queue = []; // é‡è¤‡ãªã—ã®å‡ºé¡Œã‚­ãƒ¥ãƒ¼
let qIndex = -1;
let current = '';
let running = false;

// æˆç¸¾
let correct = 0, wrong = 0, maybe = 0; const wrongMap = new Map();

/******************* è¦ç´ å‚ç…§ *******************/
const scriptSel = document.getElementById('scriptSel');
const setSel = document.getElementById('setSel');
const modeSel = document.getElementById('modeSel');
const startBtn = document.getElementById('startBtn');
const resetBtn = document.getElementById('resetBtn');
const promptEl = document.getElementById('prompt');
const choiceArea = document.getElementById('choiceArea');
const handArea = document.getElementById('handArea');
const playBtn = document.getElementById('playBtn');
const replayBtn = document.getElementById('replayBtn');
const feedback = document.getElementById('feedback');
const progress = document.getElementById('progress');
const resultPanel = document.getElementById('resultPanel');
const recordToggle = document.getElementById('recordToggle');
const recordPanel = document.getElementById('recordPanel');
const recordList = document.getElementById('recordList');
const refreshRec = document.getElementById('refreshRec');
const clearRec = document.getElementById('clearRec');
const settingsDlg = document.getElementById('settings');
const leniency = document.getElementById('leniency');
const lenVal = document.getElementById('lenVal');
const openSettings = document.getElementById('openSettings');
const saveSettings = document.getElementById('saveSettings');

// æ‰‹æ›¸ãé–¢ä¿‚
const canvas = document.getElementById('draw');
const ctx = canvas.getContext('2d');
const undoBtn = document.getElementById('undoBtn');
const clearBtn = document.getElementById('clearBtn');
const autoBtn = document.getElementById('autoBtn');
const markGood = document.getElementById('markGood');
const markMaybe = document.getElementById('markMaybe');
const markBad = document.getElementById('markBad');

/******************* ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ *******************/
function speakKana(text){ try{ if(window.speechSynthesis){ speechSynthesis.cancel(); } const u=new SpeechSynthesisUtterance(text==='ãƒ²'?'ã‚’':text); u.lang='ja-JP'; speechSynthesis.speak(u);}catch(e){} }
function showFeedback(mark){ feedback.textContent = mark; feedback.style.display='block'; setTimeout(()=>{ feedback.style.display='none'; }, 520); }
function updateProgress(){ progress.textContent = running ? `ã‚‚ã‚“ã ã„ï¼š${qIndex+1}/${queue.length}` : ''; }

/******************* Canvas å®‰å…¨åˆæœŸåŒ–ï¼ˆé«˜DPIå¯¾å¿œï¼‹ä¾‹å¤–é˜²æ­¢ï¼‰ *******************/
function ensureCanvasReady(){
  const cs = getComputedStyle(canvas);
  const cssW = parseFloat(cs.width) || canvas.offsetWidth || 320;
  const cssH = parseFloat(cs.height) || canvas.offsetHeight || 320;
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  const needW = Math.max(1, Math.floor(cssW * dpr));
  const needH = Math.max(1, Math.floor(cssH * dpr));
  if (canvas.width !== needW || canvas.height !== needH) {
    canvas.width = needW; canvas.height = needH;
    const c2d = canvas.getContext('2d');
    if (c2d) c2d.setTransform(dpr, 0, 0, dpr, 0, 0);
  }
}
function safeGetImageData(ctx, x, y, w, h){ try { return ctx.getImageData(x,y,w,h); } catch(err){ ensureCanvasReady(); try{ return ctx.getImageData(x,y,w,h);}catch(e2){ return null; } } }

/******************* æ‰‹æ›¸ãæç”»ï¼ˆPointer/Touch/Mouse å…¨å¯¾å¿œï¼‰ *******************/
let drawing=false, paths=[], currentPath=[];
function redraw(){
  ensureCanvasReady();
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.globalAlpha=1; ctx.lineCap='round'; ctx.lineJoin='round'; ctx.strokeStyle='#000'; ctx.lineWidth=14;
  for(const p of paths){ if(!p.length) continue; ctx.beginPath(); ctx.moveTo(p[0].x,p[0].y); for(let i=1;i<p.length;i++) ctx.lineTo(p[i].x,p[i].y); ctx.stroke(); }
  if(currentPath.length){ ctx.beginPath(); ctx.moveTo(currentPath[0].x,currentPath[0].y); for(let i=1;i<currentPath.length;i++) ctx.lineTo(currentPath[i].x,currentPath[i].y); ctx.stroke(); }
}
function pointFrom(e){ const r=canvas.getBoundingClientRect(); const cx=(e.clientX ?? (e.touches? e.touches[0].clientX:0)); const cy=(e.clientY ?? (e.touches? e.touches[0].clientY:0)); return {x:cx-r.left, y:cy-r.top}; }
function startDraw(e){ if(e.cancelable) e.preventDefault(); ensureCanvasReady(); drawing=true; currentPath=[pointFrom(e)]; }
function moveDraw(e){ if(!drawing) return; if(e.cancelable) e.preventDefault(); currentPath.push(pointFrom(e)); redraw(); }
function endDraw(e){ if(!drawing) return; if(e.cancelable) e.preventDefault(); drawing=false; paths.push(currentPath); currentPath=[]; redraw(); }
// Pointerï¼ˆå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶å„ªå…ˆï¼‰
canvas.addEventListener('pointerdown', e=>{ startDraw(e); canvas.setPointerCapture?.(e.pointerId); });
canvas.addEventListener('pointermove', moveDraw);
canvas.addEventListener('pointerup', endDraw);
canvas.addEventListener('pointercancel', ()=>{ drawing=false; currentPath=[]; });
// Fallback: Touch & Mouse
canvas.addEventListener('touchstart', startDraw, {passive:false});
canvas.addEventListener('touchmove', moveDraw, {passive:false});
canvas.addEventListener('touchend', endDraw, {passive:false});
canvas.addEventListener('mousedown', startDraw);
window.addEventListener('mousemove', moveDraw);
window.addEventListener('mouseup', endDraw);

undoBtn.onclick = ()=>{ if(paths.length){ paths.pop(); redraw(); } };
clearBtn.onclick = ()=>{ paths=[]; redraw(); };

/******************* åˆ¤å®šï¼ˆè‡ªå‹•ï¼šã‚†ã‚‹ã‚ï¼‰ *******************/
function thresholds(){ const v=parseInt(localStorage.getItem('kana_leniency')||leniency.value,10)||4; const table={1:[0.35,0.25],2:[0.26,0.18],3:[0.20,0.12],4:[0.15,0.09],5:[0.10,0.06]}; return table[v]||table[4]; }
function autoJudge(){ let w=canvas.width,h=canvas.height; if(w<1||h<1){ ensureCanvasReady(); w=canvas.width; h=canvas.height; if(w<1||h<1) return {ok:false,ratioA:0,ratioB:0}; }
  const drawnIm=safeGetImageData(ctx,0,0,w,h); if(!drawnIm) return {ok:false,ratioA:0,ratioB:0};
  const data=drawnIm.data; let drawnCount=0; const m1=new Uint8Array(w*h); for(let i=0;i<w*h;i++){ const a=data[i*4+3]; if(a>20){ m1[i]=1; drawnCount++; } }
  if(drawnCount<120) return {ok:false,ratioA:0,ratioB:0};
  const off=document.createElement('canvas'); off.width=w; off.height=h; const o=off.getContext('2d'); o.fillStyle='#000'; const fBase=(current.length>=2)? Math.floor(h*0.55):Math.floor(h*0.68); o.font=`normal ${fBase}px "Yu Gothic", "Noto Sans JP", sans-serif`; o.textAlign='center'; o.textBaseline='middle'; o.fillText(current,w/2,h/2+4);
  const glyphIm=safeGetImageData(o,0,0,w,h); if(!glyphIm) return {ok:false,ratioA:0,ratioB:0};
  const g=glyphIm.data; let glyphCount=0; const m2=new Uint8Array(w*h); for(let i=0;i<w*h;i++){ const a=g[i*4+3]; const sum=g[i*4]+g[i*4+1]+g[i*4+2]; if(a>10 && sum<720){ m2[i]=1; glyphCount++; } }
  if(glyphCount<200) return {ok:false,ratioA:0,ratioB:0};
  let overlap=0; for(let i=0;i<w*h;i++){ if(m1[i]&&m2[i]) overlap++; }
  const ratioA=overlap/drawnCount, ratioB=overlap/glyphCount; const [thA,thB]=thresholds(); return {ok:(ratioA>=thA && ratioB>=thB), ratioA, ratioB}; }

function mark(kind){ if(!running) return; if(kind==='good'){ correct++; showFeedback('ã€‡'); } else if(kind==='maybe'){ maybe++; showFeedback('â–³'); wrongMap.set(current,(wrongMap.get(current)||0)+1); } else { wrong++; showFeedback('Ã—'); wrongMap.set(current,(wrongMap.get(current)||0)+1); } nextQuestion(); }

// è‡ªå‹•æ¡ç‚¹ï¼ˆã“ãŸãˆï¼‰
autoBtn.onclick = ()=>{ const r=autoJudge(); if(r.ok){ mark('good'); } else { mark('bad'); } };

// å…ˆç”Ÿâ˜‘ï¼ˆã€‡/â–³/Ã—ï¼‰
markGood.onclick=()=>mark('good'); markMaybe.onclick=()=>mark('maybe'); markBad.onclick=()=>mark('bad');

/******************* 5æŠï¼ˆé‡è¤‡ãªã—ã§é€²è¡Œï¼‰ *******************/
function renderChoice(){ choiceArea.innerHTML=''; const opts = new Set([current]); if(pool.length<=5){ pool.forEach(ch=>opts.add(ch)); } else { while(opts.size<5){ const pick = pool[Math.floor(Math.random()*pool.length)]; if(pick!==current) opts.add(pick); } }
  const list = shuffle([...opts]).slice(0, Math.min(5, pool.length)); list.forEach(opt=>{ const b=document.createElement('button'); b.className='option'; b.textContent=opt; b.onclick=()=>{ if(opt===current){ correct++; showFeedback('ã€‡'); nextQuestion(); } else { wrong++; showFeedback('Ã—'); wrongMap.set(current,(wrongMap.get(current)||0)+1); } }; choiceArea.appendChild(b); }); }

/******************* é€²è¡Œåˆ¶å¾¡ï¼ˆå…¨å•å‡ºé¡Œãƒ»é †ä¸åŒãƒ»é‡è¤‡ãªã—ï¼‰ *******************/
function nextQuestion(){
  qIndex++;
  updateProgress();
  if(qIndex>=queue.length){ finish(); return; }
  current = queue[qIndex];
  speakKana(current);
  feedback.style.display='none';
  if(mode==='choice'){
    choiceArea.style.display='flex';
    handArea.style.display='none';
    renderChoice();
  } else {
    choiceArea.style.display='none';
    handArea.style.display='block';
    paths=[];
    requestAnimationFrame(()=>{ ensureCanvasReady(); redraw(); });
  }
  replayBtn.style.display = running ? 'inline-block':'none';
}

function start(){
  script=scriptSel.value; setKind=setSel.value; mode=modeSel.value;
  pool=buildPool(script,setKind);
  queue = shuffle([...pool]);
  qIndex=-1; running=true; correct=0; wrong=0; maybe=0; wrongMap.clear(); resultPanel.innerHTML='';
  promptEl.textContent=(mode==='choice')? 'ãŠã¨ã‚’ãã„ã¦ã€€ãˆã‚‰ã‚“ã§ã­' : 'ãŠã¨ã‚’ãã„ã¦ã€€ã‹ã„ã¦ã­';
  nextQuestion();
}
function resetAll(){ running=false; choiceArea.innerHTML=''; handArea.style.display='none'; choiceArea.style.display='none'; progress.textContent=''; feedback.style.display='none'; resultPanel.innerHTML=''; stopSpeak(); }
function stopSpeak(){ try{ if(window.speechSynthesis) speechSynthesis.cancel(); }catch(e){} }

/* å®Œäº†å‡¦ç† */
function finish(){
  if(!running){ return; }
  running=false; stopSpeak();
  const rec = buildRecord();
  saveRecord(rec);
  const wrongLines = Array.from(wrongMap.entries()).sort((a,b)=>b[1]-a[1]).map(([k,v])=>`${k}ï¼š${v}å›`).join('ã€€');
  resultPanel.innerHTML = `
    <div style="margin-top:14px; font-size:1.1em;">
      <div><strong>ã‘ã£ã‹</strong>ã€€ã€‡ï¼š${correct}ã€€Ã—ï¼š${wrong}ã€€â–³ï¼š${maybe}</div>
      <div style="margin-top:8px;"><strong>ã¾ã¡ãŒãˆãŸæ–‡å­—</strong>ï¼š${wrongLines || 'ãªã—'}</div>
      <div style="margin-top:10px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap;">
        <button class=\"nav-button\" onclick=\"start()\">â†» ã‚‚ã†ã„ã¡ã©</button>
      </div>
    </div>`;
  if(recordPanel.style.display==='block') { renderRecords(); }
}

/******************* è¨˜éŒ²ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼‰ *******************/
const REC_KEY='kana_test_records_v1';
function buildRecord(){ const now=new Date(); const ja=now.toLocaleString('ja-JP',{timeZone:'Asia/Tokyo'}); const wrongs=Array.from(wrongMap.entries()).map(([ch,n])=>({ch,n})).sort((a,b)=>b.n-a.n); return {date:ja, script,setKind,mode,total:queue.length,correct,wrong,maybe,wrongs}; }
function saveRecord(rec){ try{ const arr=JSON.parse(localStorage.getItem(REC_KEY)||'[]'); arr.push(rec); if(arr.length>200) arr.shift(); localStorage.setItem(REC_KEY, JSON.stringify(arr)); }catch(e){} }
function loadRecords(){ try{ return JSON.parse(localStorage.getItem(REC_KEY)||'[]'); }catch(e){ return []; } }
function renderRecords(){ const arr=loadRecords().slice().reverse(); recordList.innerHTML=''; if(!arr.length){ recordList.textContent='ï¼ˆã¾ã  ãã‚ã ãŒ ã‚ã‚Šã¾ã›ã‚“ï¼‰'; return; } for(const r of arr){ const div=document.createElement('div'); div.className='recItem'; const d=document.createElement('details'); d.innerHTML=`<summary>${r.date}ï½œ${labelScript(r.script)}ï½œ${labelSet(r.setKind)}ï½œ${labelMode(r.mode)}ï½œã€‡${r.correct} Ã—${r.wrong} â–³${r.maybe}</summary>`; const w=(r.wrongs&&r.wrongs.length)? r.wrongs.map(x=>`${x.ch}:${x.n}`).join('ã€€'):'ãªã—'; const inner=document.createElement('div'); inner.style.margin='8px 0 0'; inner.textContent=`ã¾ã¡ãŒãˆï¼š${w}`; d.appendChild(inner); div.appendChild(d); recordList.appendChild(div); } }
function labelScript(s){ return s==='hira'?'ã²ã‚‰ãŒãª':'ã‚«ã‚¿ã‚«ãƒŠ'; }
function labelSet(s){ return {seion:'æ¸…éŸ³',dakuon:'æ¿éŸ³',handakuon:'åŠæ¿éŸ³',yoon:'æ‹—éŸ³',all:'ãœã‚“ã¶'}[s]||s; }
function labelMode(m){ return m==='choice'?'5æŠ':'æ‰‹æ›¸ã'; }

function clearAllRecords(silent){
  try{
    // ç¾è¡Œã‚­ãƒ¼ã¨æ—§ã‚­ãƒ¼ã‚’ä¸¡æ–¹ã‚¯ãƒªã‚¢ï¼ˆç’°å¢ƒå·®ãƒ»æ—§ç‰ˆæ··åœ¨å¯¾ç­–ï¼‰
    const keys=[REC_KEY,'kana_test_records','kana_test_records_v0'];
    for(const k of keys){ localStorage.removeItem(k); }
    localStorage.setItem(REC_KEY, '[]');
  }catch(e){}
  if(!silent) alert('è¨˜éŒ²ã‚’æ¶ˆå»ã—ã¾ã—ãŸ');
  // DOM ã‚’å³æ™‚ç©ºè¡¨ç¤ºã«ã—ã¦ã‹ã‚‰å†æç”»ï¼ˆè¦‹ãŸç›®æ®‹ã‚Šå¯¾ç­–ï¼‰
  recordList.innerHTML='ï¼ˆã¾ã  ãã‚ã ãŒ ã‚ã‚Šã¾ã›ã‚“ï¼‰';
  // æ¬¡ã®ã‚¿ã‚¹ã‚¯ã§å†ç¢ºèª
  setTimeout(renderRecords, 0);
}

recordToggle.onclick=()=>{ recordPanel.style.display=(recordPanel.style.display==='block')?'none':'block'; if(recordPanel.style.display==='block') renderRecords(); };
refreshRec.onclick=renderRecords;
clearRec.onclick=()=>{ if(confirm('ãœã‚“ã¶æ¶ˆã—ã¾ã™ã‹ï¼Ÿ')){ clearAllRecords(false); } };

/******************* è¨­å®šï¼ˆã‚„ã•ã—ã•ï¼‰ *******************/
openSettings.onclick=()=>{ const v=parseInt(localStorage.getItem('kana_leniency')||'4',10)||4; leniency.value=String(v); lenVal.textContent=String(v); settingsDlg.showModal(); };
leniency.addEventListener('input',()=>{ lenVal.textContent=leniency.value; });
saveSettings.onclick=(e)=>{ e.preventDefault(); localStorage.setItem('kana_leniency', String(leniency.value)); settingsDlg.close(); };

/******************* é–‹å§‹/çµ‚äº† *******************/
startBtn.onclick=start; resetBtn.onclick=resetAll; playBtn.onclick=()=>{ if(current) speakKana(current); }; replayBtn.onclick=()=>{ if(current) speakKana(current); };

/******************* åˆæœŸåŒ– *******************/
ensureCanvasReady(); redraw();

/******************* ç°¡æ˜“ãƒ†ã‚¹ãƒˆï¼ˆ?dev=1ï¼‰ *******************/
(function dev(){ const p=new URLSearchParams(location.search); if(p.get('dev')!=='1') return; const panel=document.getElementById('devPanel'); panel.style.display='block'; const logs=[]; const log=(ok,msg)=>logs.push((ok?'âœ… ':'âŒ ')+msg);
  try{ const r1 = (function(){ ensureCanvasReady(); const im = safeGetImageData(ctx,0,0,canvas.width,canvas.height); return (im===null || (im.width===canvas.width)); })(); log(r1,'T1: getImageData ã§ä¾‹å¤–ã«ãªã‚‰ãªã„'); }catch(e){ log(false,'T1: ä¾‹å¤– '+e); }
  try{ // è¨˜éŒ²ã®è¿½åŠ ã¨æ¶ˆå»
    const before=loadRecords().length; saveRecord({date:'TEST',script:'hira',setKind:'seion',mode:'choice',total:1,correct:1,wrong:0,maybe:0,wrongs:[]}); const mid=loadRecords().length; clearAllRecords(true); const after=loadRecords().length; log(mid===before+1 && after===0, 'T2: è¨˜éŒ²ã®ä¿å­˜ã¨æ¶ˆå»');
  }catch(e){ log(false,'T2: ä¾‹å¤– '+e); }
  try{ // ã‚­ãƒ¥ãƒ¼ã®é‡è¤‡ãªã—
    pool=buildPool('hira','handakuon'); queue=shuffle([...pool]); const set=new Set(queue); log(queue.length===pool.length && set.size===queue.length, 'T3: å…¨å•å‡ºé¡Œãƒ»é‡è¤‡ãªã—');
  }catch(e){ log(false,'T3: ä¾‹å¤– '+e); }
  try{ // å®Œäº†å‡¦ç†ãŒå‘¼ã¹ã‚‹ & è¨˜éŒ²ãŒå¢—ãˆã‚‹
    running=true; script='hira'; setKind='seion'; mode='choice'; queue=['ã‚']; qIndex=1; current='ã‚'; correct=1; wrong=0; maybe=0; wrongMap.clear();
    const before2=loadRecords().length; finish(); const after2=loadRecords().length;
    log(after2===before2+1, 'T4: finish() ãŒè¨˜éŒ²ã‚’ä¿å­˜ã—çµæœã‚’è¡¨ç¤º');
  }catch(e){ log(false,'T4: ä¾‹å¤– '+e); }
  panel.innerHTML='<b>DEV ãƒ†ã‚¹ãƒˆ</b><br>'+logs.map(l=>'<div>'+l+'</div>').join(''); })();
</script>
</body>
</html>
